\chapter{Results}\label{chap:Results}

\section{Exploratory Data Analysis}\label{sec:Exploratory_Data_Analysis}

\subsection{HMDA Data}\label{subsec:HMDA_EDA}

After all preparation steps detailed in \textbf{chapter \ref{subsec:HMDA_Data}}, the dataset contained \textit{851,936} observations and \textit{9} features (including the target variable, \textit{loan\_granted}). 

\textbf{EDA of the Target Variable}

The target variable, \textit{loan\_granted}, is binary (\textit{Granted} or \textit{Not Granted}) and slightly imbalanced, with \textit{57.9\%} of all loans being granted. 
There were no missing values. The distribution of the target variable can be seen in \textbf{figure \ref{fig:CHXX_Target_Variable_Distribution}}.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.6\textwidth]{images/CHXX_Target_Variable_Distribution.png}
%    \caption{HMDA: Distribution of the Target Variable}
%    \medskip
%    \small
%    The target variable is slightly imbalanced, with 57.9\% (493,290) of all loans being granted.
    \caption[HMDA: Distribution of the Target Variable]{\textbf{HMDA: Distribution of the Target Variable} - The target variable is slightly imbalanced, with 57.9\% (493,290) of all loans being granted.}
    \label{fig:CHXX_Target_Variable_Distribution}
\end{figure}

Analyzing the correlation of the target variable with the categorical and numerical features showed that the \textit{debt\_to\_income\_ratio} feature has the highest correlation (moderate negative correlation of \textbf{-0.61}) with the target variable, while the other features show only weak correlations. 
The correlation of the target variable with the numerical and categorical features was calculated by pairwise Pearson correlation, with the categorical features being encoded as integers before the calculation.
The results can be seen in \textbf{table \ref{tab:CHXX_Target_Correlation_Categorical}} and \textbf{figure \ref{fig:CHXX_Target_Correlation_Numerical}}, respectively.

%\begin{figure}[hbt!]
%    \centering
%    \includegraphics[width=1\textwidth]{images/CHXX_Target_Correlation_Categorical.png}
%    \caption{HMDA: Correlation of the Target Variable with Categorical Features}
%    \medskip
%    \small
%    While there are only weak correlations between \textit{loan\_granted} and \textit{applicant\_race-1, loan\_type, lien\_status}, and \textit{applicant\_sex}, there is a moderate negative correlation of \textbf{-0.61} between \textit{loan\_granted} and \textit{debt\_to\_income\_ratio}.
%    \label{fig:CHXX_Target_Correlation_Categorical}
%\end{figure}

\begin{table}[!htbp]
    \centering
    \begin{tabular}{l c}
    \toprule
    \textbf{Feature} & \textbf{Correlation Coefficient} \\
    \midrule
    \textbf{Race} & 0.11 \\
    \textbf{Loan Type} & 0.025 \\
    \textbf{Lien Status} & -0.0051 \\
    \textbf{Sex} & -0.034 \\
    \textbf{Debt to Income Ratio} & -0.61 \\
    \bottomrule
    \end{tabular}
    \medskip
    \caption[HMDA: Correlation of the Target Variable with Categorical Features]{\textbf{HMDA: Correlation of the Target Variable with Categorical Features} - While there are only weak correlations between \textit{granted loans} and \textit{applicant race, lien status, loan type}, and \textit{applicant sex}, there is a moderate negative correlation of \textbf{-0.61} between \textit{granted loans} and \textit{debt to income ratio}.}
    \label{tab:CHXX_Target_Correlation_Categorical}
\end{table}

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.8\textwidth]{images/CHXX_Target_Correlation_Numerical.png}
%    \caption{HMDA: Correlation Between the Numerical Features}
%    \medskip
%    \small
%    While both numerical features are only weakly correlated with \textit{loan\_granted}, there is a moderate positive correlation of \textbf{0.54} inbetween them.
    \caption[HMDA: Correlation Between the Numerical Features]{\textbf{HMDA: Correlation Between the Numerical Features} - While both numerical features are only weakly correlated with \textit{loan\_granted}, there is a moderate positive correlation of \textbf{0.54} inbetween them.}
    \label{fig:CHXX_Target_Correlation_Numerical}
\end{figure}

% \subsection{Data Overview}\label{subsec:Data_Overview}

\textbf{EDA of the Features}

The processed dataset contained two \textit{numerical} features: \textbf{interest\_rate} and \textbf{loan\_to\_value\_ratio}.
% Their distributions can be seen in \textbf{Figure \ref{fig:CHXX_Numerical_Distributions_1}} and \textbf{Figure \ref{fig:CHXX_Numerical_Distributions_2}}.
Their distributions can be seen in \textbf{figure \ref{fig:CHXX_Numerical_Distributions_2}}.
% Both are positively correlated with each other with a correlation coefficient of \textit{0.54}.

%\begin{figure}[h]
%    \centering
%    \caption{Boxplots of the Numerical Features}
%    \includegraphics[width=0.85\textwidth]{CHXX_Numerical_Distributions_1.png}
%    \caption*{The results of the KNNImputer applying mean (annotated in red) values for all missing values show clearly here by the narrow quartiles.}
%    \label{fig:CHXX_Numerical_Distributions_1}
%\end{figure}

\begin{figure}[!htbp]
    \centering
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/CHXX_Numerical_Distributions_2_IR.png}
        \small
        Interest Rate
    \end{minipage}\hfill
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/CHXX_Numerical_Distributions_2_LTVR.png}
        \small
        Loan to Value Ratio
    \end{minipage}    
%    \caption{HMDA: Histograms of the Numerical Features}
%    \medskip
%    \small
%    The results of the KNNImputer applying mean (\textit{4.56\%} for the interest rate and \textit{71.24\%} for the Loan to Value Ratio) values for the loan to value ratio values for all missing values show clearly here by the high amount of values at the mean.
    \caption[HMDA: Histograms of the Numerical Features]{\textbf{HMDA: Histograms of the Numerical Features} - The results of the KNNImputer applying mean (\textit{4.56\%} for the interest rate and \textit{71.24\%} for the Loan to Value Ratio) values for the loan to value ratio values for all missing values show clearly here by the high amount of values at the mean.}
    \label{fig:CHXX_Numerical_Distributions_2}
\end{figure}

Exploratory data analysis of the categorical variables showed that the majority of loan applicants are \textbf{White} (65\%) and \textbf{Male} (85\%), resulting in 57\% of all applicants being both White and Male.
Most loans applied for are \textbf{Conventional} (82\%) and \textbf{First Lien} (86\%).
Aside from missingness in the \textit{debt\_to\_income\_ratio} feature, which alone accounts for 26\% of all values, the data in this feature are roughly normally distributed, with the mode being 14\% of values in the \textbf{36\%-41\%} range. 
The distributions of the categorical variables can be seen in \textbf{figure \ref{fig:HMDA_Categorical_Features_Distributions}}.

\begin{figure}[!htbp]

    \centering

    \begin{minipage}[b]{0.5\textwidth}
        \centering
        \begin{subfigure}[t]{0.06\textwidth}
            \textbf{a)}
        \end{subfigure}
        \begin{subfigure}[t]{0.9\textwidth}
            \includegraphics[width=\linewidth, valign=t]{images/HMDA_features/HMDA_features_sex.png}
        \end{subfigure}
    \end{minipage}%
    \begin{minipage}[b]{0.5\textwidth}
        \centering
        \begin{subfigure}[t]{0.06\textwidth}
            \textbf{b)}
        \end{subfigure}
        \begin{subfigure}[t]{0.9\textwidth}
            \includegraphics[width=\linewidth, valign=t]{images/HMDA_features/HMDA_features_race.png}
        \end{subfigure}
    \end{minipage}%
    \hfill\allowbreak%
    \begin{minipage}[b]{0.5\textwidth}
        \centering
        \begin{subfigure}[t]{0.06\textwidth}
            \textbf{c)}
        \end{subfigure}
        \begin{subfigure}[t]{0.9\textwidth}
            \includegraphics[width=\linewidth, valign=t]{images/HMDA_features/HMDA_features_lien.png}
        \end{subfigure}
    \end{minipage}%
    \begin{minipage}[b]{0.5\textwidth}
        \centering
        \begin{subfigure}[t]{0.06\textwidth}
            \textbf{d)}
        \end{subfigure}
        \begin{subfigure}[t]{0.9\textwidth}
            \includegraphics[width=\linewidth, valign=t]{images/HMDA_features/HMDA_features_type.png}
        \end{subfigure}
    \end{minipage}%
    \hfill\allowbreak%
    \begin{minipage}[b]{1\textwidth}
        \centering
        \begin{subfigure}[t]{0.06\textwidth}
            \textbf{e)}
        \end{subfigure}
        \begin{subfigure}[t]{0.92\textwidth}
            \includegraphics[width=\linewidth, valign=t]{images/HMDA_features/HMDA_features_dtir.png}
        \end{subfigure}
    \end{minipage}%

    \caption[HMDA: Distributions of the Categorical Features]{\textbf{HMDA: Distributions of the Categorical Features} - The majority of loan applicants are \textit{Male} and \textit{White} (see a) and b)). 
    Most loans applied for are \textit{Conventional} and \textit{First Lien} (see c) and d)). The \textit{debt\_to\_income\_ratio} feature is (apart from the missing values) roughly normally distributed, with the mode being 14\% of values in the \textbf{36\%-41\%} range (see e)).}
    \label{fig:HMDA_Categorical_Features_Distributions}

\end{figure}

% \subsection{Fairness}\label{subsec:Fairness}

\textbf{EDA of Fairness Aspects}

Following the scope of this thesis specified in \textbf{chapter \ref{ch:Introduction}}, a special focus needs to be put  on fairness, specifically equality with regards to the protected attribute(s).
This potential unfairness in the underlying data can be identified from assessing the distribution of the target variable across different groups.
\textbf{Figure \ref{fig:CHXX_Loan_Grant_By_Protected_Attribute}} shows the amount of (not) granted loans per race and by sex, the probabilities of being granted a loan across these groups can be found in \textbf{table \ref{tab:loan_granting}}.\@

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.85\textwidth]{images/CHXX_Loan_Grant_By_Protected_Attribute.png}
%    \caption{Loan Grant by Protected Attribute}
%    \caption*{Discrimination by race is apparent in the data, as the amount of granted loans differs significantly}
%    \medskip
    \caption[Loan Grant by Protected Attribute]{\textbf{Loan Grant by Protected Attribute} - Discrimination by race is apparent in the data, as the amount of granted loans differs significantly.}
    \label{fig:CHXX_Loan_Grant_By_Protected_Attribute}
\end{figure}

\begin{table}[!htbp]
    \centering
      \begin{tabular}{lcc}
      \toprule
      \textbf{Applicant Race} & \textbf{Applicant Sex} & \textbf{Loan Granted (\%)} \\
      \midrule
      Black or African American & Male    & 46.4 \\
            & Female  & 44.1 \\
      White & Male    & 60.9 \\
            & Female  & 58.8 \\
      \bottomrule
      \end{tabular}
%      \caption{Loan Granting Statistics by Applicant Race and Sex}
%      \caption*{Analyzing the differences in percentages of loans being granted among race and sex of applicants shows differences in the underlying data: Regardless of their gender, Black or African American applicants are less likely to be granted a loan than White applicants.}
    \medskip
    \caption[Loan Granting Statistics by Applicant Race and Sex]{\textbf{Loan Granting Statistics by Applicant Race and Sex} - Analyzing the differences in percentages of loans being granted among race and sex of applicants shows differences in the underlying data: Regardless of their gender, Black or African American applicants are less likely to be granted a loan than White applicants.}
    \label{tab:loan_granting}%
\end{table}%

Even though the focus of the analysis is on the \textit{applicant\_race-1} attribute, \textit{applicant\_sex} has been included as a second discriminating factor, as it also constitutes a protected attribute.
Inspection of the results depicted here did however imply that the issue of racial equality is more pronounced than that of inequality between the sexes.
A chi-squared test of independence proved that assumption of underlying inequality between races in the data, as the p-value is \textit{<0.01} and therefore H0 (equality in granted loans) could be rejected at any significance level.
Using the aforementioned \textbf{AIF360} package to assess the mean difference of granted loans between the races in the underlying data amounted to a \textit{14.9\%} difference.

\subsection{Enrichment Data}\label{subsec:Enrichment_Data}

The cleaned enrichment data (see \textbf{chapter \ref{subsec:Enrichment_Data}}) are \textit{complete} in a way that there are values available for all features and for all of the 469 counties. Basic summary statistics can be found in \textbf{table \ref{tab:enrichment_summary}}. 
Across all 469 counties that are included in this analysis, a high school degree is the most common highest degree, with the mean of population percentages with that degree being \textbf{32.9\%} overall, followed by a college degree with \textbf{30.9\%}. 
A high discrepancy in the educational standard between the different observational units becomes apparent when considering the presence of counties where \textbf{81.6\%} of the population have less than a high school degree, while in others, \textbf{55.2\%} have a bachelors degree or higher.
In terms of population, the counties in this analysis are heterogenous as well, with the mean population being \textbf{85.36 thousand} with standard deviation of \textbf{318.70 thousand} and the most inhabited county having nearly 100,000 times as many inhabitants as the least inhabited.
The socio-economic factors expose a wide range of values as well, with the poverty rate ranging from \textbf{3.9\%} to \textbf{43.5\%}, the median household income from \textbf{25.65 thousand} to \textbf{124.35 thousand}, and the unemployment rate from \textbf{0.6\%} to \textbf{11.0\%}.

\begin{table}[!htbp]
    \centering
    \begin{tabularx}{\textwidth}{l *{5}{>{\centering\arraybackslash}X}}
    \hline
     & \textbf{Count} & \textbf{Mean} & \textbf{Std} & \textbf{Min} & \textbf{Max} \\
    \hline
    College Degree & 469.00 & 30.9\% & 6.03 & 0.00\% & 76.92\% \\
    Bachelor Degree or Higher & 469.00 & 21.7\% & 8.42 & 0.00\% & 55.17\% \\
    High School Degree & 469.00 & 32.9\% & 6.60 & 12.93\% & 51.17\% \\
    Less than High School Degree & 469.00 & 14.5\% & 8.18 & 0.60\% & 81.55\% \\
    Population (thousands) & 469.00 & 85.36 & 318.70 & 0.05 & 4,780.91 \\
    Poverty Rate & 469.00 & 15.9\% & 6.23 & 3.90\% & 43.50\% \\
    Median Household Income (thousands) & 469.00 & 56.6 & 13.94 & 25.65 & 124.35 \\
    Unemployment Rate & 469.00 & 3.6\% & 1.21 & 0.60\% & 11.00\% \\
    \hline
    \end{tabularx}
%    \caption{Summary Statistics of the Enrichment Data}
%    \small
%    The summary statistics show that the data is complete and has a wide range of values.
    \medskip
    \caption[Summary Statistics of the Enrichment Data]{\textbf{Summary Statistics of the Enrichment Data} - The summary statistics show that the data is complete and has a wide range of values.}
    \label{tab:enrichment_summary}
\end{table}

%A closer look into the discrepancies between the highest and lowest values of selected enrichment features can be found in \textbf{figure \ref{fig:CH03_Geo_High_Low}}.
%In terms of population, the high discrepancy betwen lowest and highest value is pronounced by the fact that the highest populated \textit{Harris County} has nearly twice as many inhabitants as the second-largest \textit{Dallas County}, while the lowest populated \textit{Loving County} has less than a fourthof the inhabitants of the second-smallest \textit{King County}.
%Similar outlier values can be found in the unemployment rate with \textit{Loving county} (0.6\%) differing strongly from 

%\begin{figure}[h]
%    \centering
%    \includegraphics[width=0.85\textwidth]{images/CH03_Geographic_Low_vs_High.png}
%    \caption{Highest and Lowest Values of Selected Enrichment Features}
%    \medskip
%    \small
%    There is a wide range in the numerical enrichment features, creating some natural outliers.
%    \label{fig:CH03_Geo_High_Low}
%\end{figure}

Expectedly, there is a high correlation between some of the features (see \textbf{figure \ref{fig:CH03_Enrichment_Correlation}}).
While a bachelors degree or higher tends to be associated with a higher median household income (positive correlation of \textbf{0.62}), a high school degree or less than a high school degree as a highest degree is associated with a higher poverty rate (positive correlation of \textbf{0.33} and \textbf{0.54} respectively).
A similar relation of socio-economic factors with education can be observed in the correlation of the unemployment rate with the highest degree, with a negative correlation of \textbf{-0.42} for holders of a bachelors degree or higher, compared to a positive correlation of \textbf{0.53} for less than a high school degree, implying that on average, observational units with less than a high school degree a more likely to be unemployed than those with a bachelors degree or higher.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.85\textwidth]{images/CH03_Enrichment_Correlation.png}
%    \caption{Correlation Between the Enrichment Features}
%    \medskip
%    \small
%    Some of the enrichment features expectedly show a high correlation, an example being \textit{median\_household\_income} and \textit{poverty\_rate}.
    \caption[Correlation Between the Enrichment Features]{\textbf{Correlation Between the Enrichment Features} - Some of the enrichment features expectedly show a high correlation, an example being \textit{median\_household\_income} and \textit{poverty\_rate}.}
    \label{fig:CH03_Enrichment_Correlation}
\end{figure}

As stated before, analyzing the geographical information provided in the enrichment dataset (see \textbf{chapter \ref{subsec:Explainability}}) was expected to provide additional insights into the fairness of the model.
A sign of potential discrimination in the data could be the correlation between race and potentially favorable outcomes, such as a higher percentage of granted loans or a lower poverty rate.
\textbf{Figure \ref{fig:Scatter_White_Applicants_Loan_Grant}} shows a scatterplot that relates the percentage of White applicants to the percentage of granted loans per county. It indicates that a higher percentage of white applicants per county does not only seem to be correlated with a higher percentage of these loans actually being granted, but also with a lower poverty rate on average.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.85\textwidth]{images/CHXX_Perc_Grants_vs_Perc_White.png}
%    \caption{Relationship between Applicant Race, Poverty Rate and Loan Grants}
%    \caption*{Counties with predominantly White applicants do not only tend to have a lower poverty rate on average, but also see a higher percentage of loans being granted on average.}
    \caption[Relationship between Applicant Race, Poverty Rate and Loan Grants]{\textbf{Relationship between Applicant Race, Poverty Rate and Loan Grants} - Counties with predominantly White applicants do not only tend to have a lower poverty rate on average, but also see a higher percentage of loans being granted on average.}
    \label{fig:Scatter_White_Applicants_Loan_Grant}
\end{figure}

It should be noted that the distributions within the enrichment data themselves are skewed by nature, as there are way higher numbers of White applicants in the data set and only few counties have a substantial number of predicted mortgage grants (see \textbf{figure \ref{fig:Enrichment_Data_EDA}}).

\begin{figure}[!htbp]
    \centering
    \begin{minipage}{0.33\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/geo_enrich/predictions_per_county.png}
        \small
        Applications per County
    \end{minipage}\hfill
    \begin{minipage}{0.33\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/geo_enrich/perc_predictions.png}
        \small
        Percentage of Grants
    \end{minipage}\hfill
    \begin{minipage}{0.33\textwidth}
        \centering
        \includegraphics[width=\textwidth]{images/geo_enrich/white_per_county.png}
        \small
        Percentage of White Applicants
    \end{minipage}\hfill
%    \caption{Enrichment Data EDA}
    \caption[Enrichment Data EDA]{\textbf{Enrichment Data EDA} - Analyzing the enrichment data shows that while the percentage of predictions per county appears to be normally distributed, the distributions of the percentage of White applicants and the percentage of predicted loans per county are skewed.}
    \label{fig:Enrichment_Data_EDA}
%    \medskip
%    \small
%    Analyzing the enrichment data shows that while the percentage of predictions per county appears to be normally distributed, the distributions of the percentage of White applicants and the percentage of predicted granted loans per county are skewed.
\end{figure}

\newpage

%\input{chapters/main/subchapters_separate/Results/Results_V1.tex}
\input{chapters/main/subchapters_separate/Results/Results_V2.tex}